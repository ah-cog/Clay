<!DOCTYPE html>
<html>
<head>
    <title>Pixel</title>
    <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-combined.min.css" rel="stylesheet">
    <script src="javascripts/acorn.js"></script>
    <script src="javascripts/interpreter.js"></script>
    <script src="javascripts/processing.js"></script> 
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
    <style>

        html, body, #carousel, #carousel ul, #carousel li {
            min-height: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            position: relative;
        }

        #debug {
            position: fixed;
            background: #fff;
            padding: 5px;
            color: #000;
            top: 0;
            left: 0;
            z-index: 1337;
        }

        #carousel {
            background: silver;
            overflow: hidden;
            width:100%;
            -webkit-backface-visibility: hidden;
            -webkit-transform: translate3d(0,0,0) scale3d(1,1,1);
            -webkit-transform-style: preserve-3d;
        }

        #carousel ul.animate {
            -webkit-transition: all .3s;
            -moz-transition: all .3s;
            -o-transition: all .3s;
            transition: all .3s;
        }

        #carousel ul {
            transform: translate3d(0%,0,0) scale3d(1,1,1);
            -o-transform: translate3d(0%,0,0) scale3d(1,1,1);
            -ms-transform: translate3d(0%,0,0) scale3d(1,1,1);
            -moz-transform: translate3d(0%,0,0) scale3d(1,1,1);
            -webkit-transform: translate3d(0%,0,0) scale3d(1,1,1);
            overflow: hidden;
            -webkit-backface-visibility: hidden;
            -webkit-transform-style: preserve-3d;
        }

        #carousel ul {
            -webkit-box-shadow: 0 0 20px rgba(0,0,0,.2);
            box-shadow: 0 0 20px rgba(0,0,0,.2);
            position: relative;
        }

        #carousel li {
            float: left;
            overflow: hidden;
            -webkit-transform-style: preserve-3d;
            -webkit-transform: translate3d(0,0,0);
        }

        #carousel li h2 {
            color: #fff;
            font-size: 30px;
            text-align: center;
            position: absolute;
            top: 40%;
            left: 0;
            width: 100%;
            text-shadow: -1px -1px 0 rgba(0,0,0,.2);
        }

        #carousel li.pane1 { background: #42d692; }
        #carousel li.pane2 { background: #4986e7; }
        #carousel li.pane3 { background: #d06b64; }
        #carousel li.pane4 { background: #cd74e6; }
        #carousel li.pane5 { background: #9fe1e7; }





        .drag {
            position: absolute;
            left: 100px;
            top: 100px;
            background: #9fe1e7;
            border-radius: 50px;
            width: 100px;
            height: 100px;
        }

        .drag1 { background: #42d692; }
        .drag2 { background: #4986e7; }
        .drag3 { background: #d06b64; }
        .drag4 { background: #cd74e6; }
        .drag5 { background: #9fe1e7; }

    </style>
</head>

<body>

<!-- <h1>Drag the balls!</h1> -->



    <!--<div id="debug">Log</div>-->

    <div id="carousel">
        <ul>

            <li class="pane1">
              <canvas id="canvas1" style="width: 100%; height: 100%;"></canvas>
            </li>

            <li class="pane2">
              <div class="nodes" style="width:800px; margin:0 auto;">
                <div class="drag drag1"></div>
                <div class="drag drag2"></div>
                <div class="drag drag3"></div>
                <div class="drag drag4"></div>
                <div class="drag drag5"></div>
              </div>
            </li>

            <li class="pane3"><h2>...or swipe...</h2></li>
            <li class="pane4"><h2>..or drag...</h2></li>
            <li class="pane5"><h2>Dit is het einde!</h2></li>
        </ul>
    </div>


    <!-- jQuery is just for the demo! Hammer.js works without jQuery :-) -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <script src="javascripts/modernizr.js"></script>

    <script src="javascripts/jquery.hammer.min.js"></script>

    <script>

    var debug_el = $("#debug");
    function debug(text) {
        debug_el.text(text);
    }


    /**
     * requestAnimationFrame and cancel polyfill
     */
    (function() {
        var lastTime = 0;
        var vendors = ['ms', 'moz', 'webkit', 'o'];
        for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
            window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
            window.cancelAnimationFrame =
                    window[vendors[x]+'CancelAnimationFrame'] || window[vendors[x]+'CancelRequestAnimationFrame'];
        }

        if (!window.requestAnimationFrame)
            window.requestAnimationFrame = function(callback, element) {
                var currTime = new Date().getTime();
                var timeToCall = Math.max(0, 16 - (currTime - lastTime));
                var id = window.setTimeout(function() { callback(currTime + timeToCall); },
                        timeToCall);
                lastTime = currTime + timeToCall;
                return id;
            };

        if (!window.cancelAnimationFrame)
            window.cancelAnimationFrame = function(id) {
                clearTimeout(id);
            };
    }());


    /**
    * super simple carousel
    * animation between panes happens with css transitions
    */
    function Carousel(element)
    {
        var self = this;
        element = $(element);

        var container = $(">ul", element);
        var panes = $(">ul>li", element);

        var pane_width = 0;
        var pane_count = panes.length;

        var current_pane = 0;


        /**
         * initial
         */
        this.init = function() {
            setPaneDimensions();

            $(window).on("load resize orientationchange", function() {
                setPaneDimensions();
                //updateOffset();
            })
        };


        /**
         * set the pane dimensions and scale the container
         */
        function setPaneDimensions() {
            pane_width = element.width();
            panes.each(function() {
                $(this).width(pane_width);
            });
            container.width(pane_width*pane_count);
        };


        /**
         * show pane by index
         * @param   {Number}    index
         */
        this.showPane = function( index ) {
            // between the bounds
            index = Math.max(0, Math.min(index, pane_count-1));
            current_pane = index;

            var offset = -((100/pane_count)*current_pane);
            setContainerOffset(offset, true);
        };


        function setContainerOffset(percent, animate) {
            container.removeClass("animate");

            if(animate) {
                container.addClass("animate");
            }

            if(Modernizr.csstransforms3d) {
                container.css("transform", "translate3d("+ percent +"%,0,0) scale3d(1,1,1)");
            }
            else if(Modernizr.csstransforms) {
                container.css("transform", "translate("+ percent +"%,0)");
            }
            else {
                var px = ((pane_width*pane_count) / 100) * percent;
                container.css("left", px+"px");
            }
        }

        this.next = function() { return this.showPane(current_pane+1, true); };
        this.prev = function() { return this.showPane(current_pane-1, true); };



        function handleHammer(ev) {
            console.log(ev);
            // disable browser scrolling
            ev.gesture.preventDefault();

            if (!disableEventCreate) {

                switch(ev.type) {
                    case 'dragright':
                    case 'dragleft':
                        // stick to the finger
                        var pane_offset = -(100/pane_count)*current_pane;
                        var drag_offset = ((100/pane_width)*ev.gesture.deltaX) / pane_count;

                        // slow down at the first and last pane
                        if((current_pane == 0 && ev.gesture.direction == Hammer.DIRECTION_RIGHT) ||
                            (current_pane == pane_count-1 && ev.gesture.direction == Hammer.DIRECTION_LEFT)) {
                            drag_offset *= .4;
                        }

                        setContainerOffset(drag_offset + pane_offset);
                        break;

                    case 'swipeleft':
                        self.next();
                        ev.gesture.stopDetect();
                        break;

                    case 'swiperight':
                        self.prev();
                        ev.gesture.stopDetect();
                        break;

                    case 'release':
                        // more then 50% moved, navigate
                        if(Math.abs(ev.gesture.deltaX) > pane_width/2) {
                            if(ev.gesture.direction == 'right') {
                                self.prev();
                            } else {
                                self.next();
                            }
                        }
                        else {
                            self.showPane(current_pane, true);
                        }
                        break;
                }

            }
        }

        element.hammer({ drag_lock_to_axis: true })
            .on("release dragleft dragright swipeleft swiperight", handleHammer);

        // element
        //   .hammer({ drag_max_touches: 0 })
        //   //.on("touch drag dragright dragleft", function(ev) {
        //   .on("touch", function(ev) {
        //     console.log("Create circle!");

        //     var touches = ev.gesture.touches;

        //     // for(var t=0,len=touches.length; t<len; t++) {
        //     //     var target = $(touches[t].target);
        //     //     target.css({
        //     //         zIndex: 1337,
        //     //         left: touches[t].pageX-50,
        //     //         top: touches[t].pageY-50
        //     //     });
        //     // }
            
        //     $(".nodes").append("<div class=\"drag drag5\"></div>");
        //     // <div class="drag drag5"></div>
        //     ev.gesture.preventDefault();
        //     ev.stopPropagation();
        //     ev.gesture.stopPropagation();
        //     return;
        //   });
    }


    var carousel = new Carousel("#carousel");
    carousel.init();


    // $(".drag")
    //   .hammer({ drag_max_touches: 0 })
    //   .on("touch drag dragright dragleft", function(ev) {
    //     console.log("DRAG CIRCLE");

    //     var touches = ev.gesture.touches;

    //     for(var t=0,len=touches.length; t<len; t++) {
    //         var target = $(touches[t].target);
    //         target.css({
    //             zIndex: 1337,
    //             left: touches[t].pageX-50,
    //             top: touches[t].pageY-50
    //         });
    //     }

    //     ev.gesture.preventDefault();
    //     ev.stopPropagation();
    //     ev.gesture.stopPropagation();
    //     return;
    //   });


    </script>

    <script src="javascripts/ga.js"></script>

    <script type="application/processing" data-processing-target="canvas1">

        // devices = [];

        disableEventCreate = false;

        function EventLoop(options) {
            var defaults = {
                events: []
            };
            var options = options || {};
            var options = $.extend({}, defaults, options);

            this.events = options.events; // events on the event loop
        }

        function Event(options) {
            var defaults = {
                x: null,
                y: null,
                xTarget: null,
                yTarget: null,
                visible: true
            };
            var options = options || {};
            var options = $.extend({}, defaults, options);

            this.x = options.x;
            this.y = options.y;

            this.targetX = options.targetX;
            this.targetY = options.targetY;

            this.visible = options.visible;
        }

        eventLoop = new EventLoop();

        void setup() {
            size(screenWidth, screenHeight);
        }

        void draw() {
            // erase background
            background(255, 255, 255, 0);

            drawEventLoop();
            drawEvents();
        }

        void drawEventLoop() {

            pushMatrix();

            // Draw the "loop" circular arc
            strokeWeight(1.0);
            stroke("#000000");
            noFill();
            smooth();
            arc(screenWidth / 2, screenHeight / 2, 400, 400, (-PI/2) + 0.05*PI, 1.45*PI);

            // Draw arrow
            translate(screenWidth / 2, screenHeight / 2);
            translate(-29, -198);
            rotate(-0.05*PI);
            line(0, 0, -16, 16);
            line(0, 0, -16, -16);

            popMatrix();
        }

        function drawEvents() {

            pushMatrix();

            var eventCount = eventLoop.events.length;
            for (var i = 0; i < eventCount; i++) {
                var loopEvent = eventLoop.events[i];

                if (loopEvent.visible === false) {
                    updatePosition(loopEvent);
                }

                fill(66, 214, 146);
                ellipse(loopEvent.x, loopEvent.y, 50, 50);

                // Calculate nearest point on circle
                //line(loopEvent.x, loopEvent.y, screenWidth / 2, screenHeight / 2);
            }

            popMatrix();
        }

        function getPointOnCircle(radius, originX, originY, angle) {
            //var radius = 50;
            //var originX = 400;
            //var originY = 400;
            //var angle = 40;

            x = originX + radius * Math.cos(angle);
            y = originY + radius * Math.sin(angle);

            var result = { x: x, y: y };

            return result;
        }

        function updatePosition(loopEvent) {

            deltaX = mouseX - (screenWidth / 2);
            deltaY = mouseY - (screenHeight / 2);
            //angleInDegrees = Math.atan(deltaY / deltaX) * 180 / PI;
            angleInDegrees = Math.atan2(deltaY, deltaX); // * 180 / PI;

            x = screenWidth / 2 + (400 / 2) * Math.cos(angleInDegrees);
            y = screenHeight / 2 + (400 / 2) * Math.sin(angleInDegrees);

            loopEvent.x = x;
            loopEvent.y = y;
        }



        $("#canvas1").hammer({ drag_max_touches: 0 }).on("touch", function(ev) {
            console.log("Touch canvus event!");

            var touches = ev.gesture.touches;

            // Get the touched object, if one exists
            var eventCount = eventLoop.events.length;
                for (var i = 0; i < eventCount; i++) {
                var loopEvent = eventLoop.events[i];
                if ((ev.gesture.center.pageX - 50 < loopEvent.x && loopEvent.x < ev.gesture.center.pageX + 50)
                    && (ev.gesture.center.pageY - 50 < loopEvent.y && loopEvent.y < ev.gesture.center.pageY + 50)) {

                    loopEvent.visible = false;
                    disableEventCreate = true;

                    console.log("touched event " + i);
                    break;
                }
            }


            // y = screenHeight / 2 + (400 / 2) * Math.sin(angleInDegrees);

            // var event2 = new Event(x, y);
            // events.push(event2);

            ev.gesture.preventDefault();
            ev.stopPropagation();
            ev.gesture.stopPropagation();
            return;
        });

        $("#canvas1").hammer({ drag_max_touches: 0 }).on("release", function(ev) {
            console.log("release event");

            var touches = ev.gesture.touches;

            // Get the touched object, if one exists
            var eventCount = eventLoop.events.length;
            for (var i = 0; i < eventCount; i++) {
                var loopEvent = eventLoop.events[i];
                if (loopEvent.visible == false) {

                    deltaX = ev.gesture.center.pageX - (screenWidth / 2);
                    deltaY = ev.gesture.center.pageY - (screenHeight / 2);
                    //angleInDegrees = Math.atan(deltaY / deltaX) * 180 / PI;
                    angleInDegrees = Math.atan2(deltaY, deltaX); // * 180 / PI;

                    x = screenWidth / 2 + (400 / 2) * Math.cos(angleInDegrees);
                    y = screenHeight / 2 + (400 / 2) * Math.sin(angleInDegrees);

                    loopEvent.x = x;
                    loopEvent.y = y;

                    loopEvent.visible = true;
                    disableEventCreate = false;

                    break;
                }
            }


        // y = screenHeight / 2 + (400 / 2) * Math.sin(angleInDegrees);

        // var event2 = new Event(x, y);
        // events.push(event2);

        ev.gesture.preventDefault();
        ev.stopPropagation();
        ev.gesture.stopPropagation();
        return;
    });

    



    $("#canvas1").hammer({ drag_max_touches: 0, hold_timeout: 200 }).on("hold", function(ev) {
        console.log("Create event!");

        if (!disableEventCreate) {

            var touches = ev.gesture.touches;

            // for(var t=0,len=touches.length; t<len; t++) {
            //     var target = $(touches[t].target);
            //     target.css({
            //         zIndex: 1337,
            //         left: touches[t].pageX-50,
            //         top: touches[t].pageY-50
            //     });
            // }
            
            deltaX = ev.gesture.center.pageX - (screenWidth / 2);
            deltaY = ev.gesture.center.pageY - (screenHeight / 2);
            //angleInDegrees = Math.atan(deltaY / deltaX) * 180 / PI;
            angleInDegrees = Math.atan2(deltaY, deltaX); // * 180 / PI;

            x = screenWidth / 2 + (400 / 2) * Math.cos(angleInDegrees);
            y = screenHeight / 2 + (400 / 2) * Math.sin(angleInDegrees);
            
            var event2 = new Event({ x: x, y: y });
            event2.visible = true;
            eventLoop.events.push(event2);
        }

        ev.gesture.preventDefault();
        ev.stopPropagation();
        ev.gesture.stopPropagation();
        return;
      });
    </script>

</body>
</html>
